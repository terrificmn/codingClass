# battery rs485 BMS
아무래도 delay가 필요한 듯 하다.   

일단 Serial2 로 rs485 컨버터와 연결을 했는데, 컨버터 자체는 5v 권장이지만 esp32 특성상 3.3V 로 연결   
**3.3V로도 정상 작동한다**

Serial 을 115200 을 연결하고 Serial2를 9600 으로 연결해서 사용하는 경우   
Serial 은 디버깅 용으로 사용하고 통신은 Serial2로 만 사용해서 디버깅 출력하는 것 외에는 문제가 없을 것이라고 생각했으나   

Serial로 출력을 하면, 그 출력하는 시간 만큼 Serial2 를 위한 데이터를 충분히 만들어 낸다   

하지만, Serial을 출력을 안 하게되면 충분한 데이터를 만들지 못한다.   
그냥 9600으로 통일 해준다.   

그리고 현재 사용하고 있는 BMS (배터리에서 주는 rs485통신) 에는   
딜레이를 (20)밀리 세컨드 이상 줘야지 잘 작동하는 것 같다....   

이왕이면 딜레이가 없었으면 좋겠지만.. 딜레이를 안 주면 데이터를 처리할 때 스킵이 되는 현상 발생  
이는 코드에 문제가 있을 수도 있게지만 여러번 테스트 해보았을 때 딜레이를 주면 잘 작동   

> 참 이상하지만,,, 딜레이를 안 주고 디버깅 용도로 Serial 출력을 하면 또 데이터가(처리) 잘 만들어짐   
하지만 Serial 출력을 안하면 또 데이터 만드는 것이 스킵  
(정확하게는 덜 만들어 짐.. vector로 push_back 해주는 작업 또는 queue를 이용한 작업)  


## 최초 사용했던 BMS 버전과 다름
프로토콜 자체가 달라지지만, 10mV 단위가 사용하는 것은 같다.   

하지만 그 예전 버전에서는 voltage 데이터를 High, Low 순서로 보냈으나, (16bits, 8비트씩)   

새로운 버전에서는 voltage 데이터를 Low, High 순서로 보내준다.

High 값 (Hex값)을  계산할 때에는 256을 곱해주거나 쉬프트 연산을 해준다. 그리고 Low 와 더해주면 된다


```cpp
int high_v = data[10] * 256;  
// 또는 
int high_v = data[10] << 8;
```
(인덱스 10이 voltage라고 가정)
