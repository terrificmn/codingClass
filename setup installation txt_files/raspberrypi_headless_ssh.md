# Raspberrypi headless SSH 접속하기
headless라고 하면 모니터, 키보드, 마우스가 없는 상태에서 하는 것을 의미한다고 하는데..  
그냥 다른 컴에서 ssh를 이용해서 원격으로 접속해서 사용하겠다 뭐.. 그런 말 ㅋㅋ

원격으로 하니깐 키보드, 모니터를 보면서 하는데 뭘? 하다가..  
생각을 해보니.. 라즈베리 파이의 전원만 빨간색으로 켜져 있는 상태로..   
구석에 혼자 덩그러니 있는 것을 보니.. headless가 맞는거 같다..  
먼저 라즈베리파이 os가 설치되어 있어야한다.  

자~ 시작!

<br>

micro sd카드를 usb 리더기에 꽂은다음에 마운트를 시켜준다.  
/boot 디렉토리로 이동

```
cd /boot
```

ssh라는 파일을 만들어 준다. 확장자, 내용 필요없음
```
$touch ssh
```

어쨋든 ssh파일이 있으면 라즈베리파이가 부팅될 때 ssh가 허용되게 설정이 바뀐다고 한다.
그리고 ssh로 만들어 놓은 파일은 지워진다고 함.

그 다음은 wpa_supplicant.conf 파일을 만들어서 와이파이 연결 설정을 해줘야함  
경로는 마찬가지로 /boot 안이다
```
vi wpa_supplicant.conf
```

아래의 내용을 추가
```
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=US
```
저장 하고 빠져나온다. country는 일단 미국으로 하는게 좋다고 한다.

그리고 이제 와이파이의 ssid와 패스워드가 필요하다.  
와이파이 ssid는 와이파이 검색했을 때 나오는 이름이다.  
그리고 패스워드는 그냥 입력해도 되지만 암호화 시킬 수가 있다.

wpa_passphrase 명령어를 사용하는데, 먼저 와이파이 ssid를 입력해주면 비밀번호를 입력하라고 나온다

예:
wpa_passphrase myhomessid  
그러면 명령어가 입력된 후 프롬포트 커서가 깜빡깜빡 거린다..   
패스워드를 입력해주면 된다.  

이를 리다이렉트를 이용해서 한번에 파일에 입력되게 해주면 된다.
```
$wpa_passphrase WiFi5GHOME >> ./wpa_supplicant.conf 
```
자신의 와이파이 이름을 적어준다.  파일은 경로를 확인할 것. 엔터를 치면  
커서만 깜빡거리는데 이때 패스워드를 입력해준다. 그리고 엔터 

그리고 나서 vi 편집기로 wap_supplicant.conf를 열어보면
```
network={
        ssid="WiFi5GHOME"
        #psk="123456789"
        psk=2fe882f3512ab4f27139e52ab10dcb6a45212da077b0d5063031312d0ede7c86
}

```
입력되어 있다.
psk=라는 부분이 주석처리 되어 있는데 암호화 처리가 되어 있는데 암호가 남아있으면 이상한 것 아닌가?
지워준다음에 저장해준다.  

물론 암호화 신경 안쓸 사람은 
위의 네트워크 부분을 직접 써줘도 되고 psk="123456789" 처럼 패스워드를 직접 넣어주면 된다. 

<br>


이제 sd카드를 umount 한 후에 라즈베리 파이에 꽂아준 후에 부팅을 해준다.

모니터가 없으므로.. 조금.. 차분하게 한? 1분 기다려준다.  

그리고 나서 본 메인 컴퓨터에서 터미널을 열어준 후에 ssh로 접속을 하면된다.
처음에 아이디는 pi이고  
암호는 raspberry 이다~

ssh로 접속을 할 때는 같은 네트워크 환경이어야 한다~  
아무래도 가장 좋은 것은 라즈베리파이가 무선 와이파이를 사용하기 때문에   
ssh를 사용하는 컴퓨터에서도  
무선 와이파이를 사용해서 같은 공유기 안에 접속이 이뤄지는게 가장 속 편하다...  

하지만.. 다른 네트워크에서 내부 사설ip로 접속하려면..     
포트포워딩해보기!를 참고하자!

<br>

# dhcp static으로 변경하기
라즈베리 파이가 무선인터넷을 사용하지만 dhcp로 되어 있어..  
자동으로 ip를 할당 받는데.. 그래서 아이피가 바뀔 수 있기 때문에 설정을 변경해준다.

뭐.. 사실 왠만하면 안바뀐다. ㅋㅋ 그래도 바꿔주면 ip가 고정이 되니   
도움이 되겠지 ^^

```
sudo vi /etc/dhcpcd.conf
```

Example static IP configuration: 아래에 주석처리되어 있는 부분을 해제해서 사용
또는 수정
```
interface wlan0
static ip_address=10.7.1.35/24 
static routers=10.7.1.3
static domain_name=8.8.8.8
```
interface eth0에서 wlan0으로 수정~ 무선랜~사용
static ip_address가 고정시킬 아이피 주소
dhcp로 받은 주소를 참고해서 써준다.
static routers는 게이트웨이가 되고 10.7.1.3  또는 192.168.1.1
static domain_name은 8.8.8.8 로 고정해주기~ 구글 DNS서버

그리고 reboot를 해준다

route 를 해보면 Gateway가 나온다.
192.168.35.1 

192.168.35.248


<br>

# ssh 포트포워딩 하기

ssh로 접속을 할 때는 같은 네트워크 환경이어야 한다~  
아무래도 가장 좋은 것은 라즈베리파이가 무선 와이파이를 사용하기 때문에   
ssh를 사용하는 컴퓨터에서도 무선 와이파이를 사용해서
같은 네트워크에 있으면 좋다..   
아마도 검색을 해보면 이런 부분을 쉽게 찾을 수 있을 것이고..  
내부 사설ip이므로 (같은 네트워크)이니깐 쉽게 ssh로 접속하면 될 것이다..

예를 들어
```
$ssh pi@192.168.1.2 
```
뭐 이런식이면 되지 않을까?  

하지만.. 나의 메인컴은 떡하니... 와이파이가 아니다 ㅠ
랜선이 꽂혀있고.. 당당하게 흔히 아는 내부 사설ip가 아니다.. 외부에서도 접속이 가능한 ip
암튼.. 그렇다. ㅋㅋ

이렇게 공유기를 사용하는 경우에는 공유기가 공인ip를 하나를 가지고 
사설ip를 만들어서 내부 네트워크를 만들어주는데..
외부에서 내부망으로 접속할 수 있는 방법이 있는데.. 그게 바로 포트 포워딩  
Port Forwarding~


포트포워딩 
원래 아이피를 알아야함
원래 무선아이피로 연결이 되어 있으면 아마도 192.168.xxx.xxx로 시작되는 사설 ip로 배정을 받을 텐데..
현재 메인 컴퓨터는 유선랜으로 연결되어 있고 175.117.xxx.xxx로 시작되고 있었다..

그래서 라즈베리 파이로 접속을 해야하는데 
headless로 접속을 하고 싶었다.. (모니터/키보드/마우스 없이 하는 것을 의미- ssh로 접속하겠다 뭐.. 이런거..)

먼저 포트포워딩이라는 것을 해야함
각각 인터넷 서비스 업체마다 다르므로 해당 공유기에 접속을 하는 방법을 찾아야한다.. 

아 그리고... 로컬 컴으로는 접속을 할 수가 없다.. 와이파이가 아니어서 192.사설망으로 접속이 안된다.;;;
그래서 휴대폰으로 접속을 시도;;
sk broad밴드는 192.168.35.1 로 웹브라우저에 입력하면 접속을 할 수 있고
아이디는 admin
비번은 공유기에 보면 적혀있는 무선랜암호로 적혀있는 것일줄 알았으나;;; 아님
공유기 아래쪽이나 옆에 보면 유선MAC 무선MAC주소가 있는데 
나의 경우는 유선MAC주소가 비번이였다. 마지막 4개가 진하게 처리되어 있는데 이것도 fake ㅋㅋ;;;
뒷자리 6자리가 비번이였고 _admin을 붙여야한다 
대소문자를 구별
예 admin에 
비번은 A360DF_admin
이런식이였다;;;  아 이거부터가 오래걸림... 비번이 틀렸다고 하던가;; 아예 서버 반응이 없다는 식으로 나온다...

이제 로그인이 되었다면..
첫번째로 메모를 할 것은 아이피 주소
아마도 위의 내 로컬 컴도 175..로 받는 것도 원래 아이피가 있는 것 같다.. 
WAN라고 써있는 주소를 찾으면 된다는데;; 그런것은 없고
처음 상태정보를 보면
IP 주소가 나오는데 222.235.xxx.xxx로 시작되는 것을 확인할 수 있었음

이제 두번째는 라즈베리파이의 접속을 아이피를 확인할 차례
이거는 관리탭에 들어가보면 커넥션 통계가 있는데
IP별 커넥션 정보를 알 수가 있는데 현재 공유기에 접속된 단말기가 다 뜬다.
핸드폰 2개, raspberrypi 놈도 당당히 있는것을 확인!
ip주소는 192.168.35.248

또 따로 적어놓는다...

세 번째는 포트포워딩을 할 차례
방화벽 메뉴에서 포트 포워딩이라는 것을 찾을 수 있고.. 다른 프로그램이여도 아마도 비슷할 듯..
포트 포워딩만 찾으면 된다..
서비스 포트는 몇번 포트로 들어오는지를 정하는 것인데..
ssh를 사용할 것인데 원래 22번을 사용하지만 다른 번호를 지정해도 무방. 일단 22번은 겹치기도 하고..
10123 이런식으로 넣어줌
프로토콜은 TCP/UDP 
중요한 내부ip주소는 192.168.35.248 위에서 찾은 라즈베리파이 주소를 적어준다
포트는 22번 (ssh가 22번 사용)
설명은 간단하게 적어줌 

그리고 적용을 눌러주면 된다..

그러면 거의 다 온것임.. ㅋㅋ

몇번의 확인을 해봤더니 재부팅을 해줘야한다. 
이것저것 하다보니 재부팅도 해보고 이 명령어 저 명령어도 쓴 탓에 
정확하게 몰랐는데.. 포트포워딩을 해주고나서 삭제를 해도 재부팅을 
안했더니 계속 접속이 가능하다가 재부팅을 했더니 그 다음부터는 접속이 안됨
즉, 포트포워딩 설정을 추가했으면 재부팅을 해주자.
메뉴를 잘 찾아보면 재부팅이 있음. sk broad는 재부팅하는데 한 1분 걸리는 듯..



이제 로컬에서 메인컴에서 ssh로 접속을 시도할 차례, 
처음으로 알아낸 메인주소 222.235.xxx.xxx 로 접속을 하는데 포트번호는 위에서 정해준 10123 이다
-p 10123 옵션으로 정해준다.
이렇게 접속을 시도하면 공유기에서 알아서 포트를 포워~딩 포트를 전달한다고 생각하면 될 것 같다...
내부 ip 192.168.xxx.xxx 라즈베리 파이 22번 포트로 연결을 해줌

```
$ssh pi@222.235.123.123 -p 10200
```

이렇게 하면 
Are you sure you want to continue connecting (yes/no/[fingerprint])? 라고 물어보고
yes 한번 눌러주고

비밀번호를 물어본다
초기 비번은 raspberry 이므로 입력

```
SSH is enabled and the default password for the 'pi' user has not been changed.
This is a security risk - please login as the 'pi' user and type 'passwd' to set a new password.

pi@raspberrypi:~ $ ls
Bookshelf  Documents  Music     Public     Videos
Desktop    Downloads  Pictures  Templates
```
이렇게 들어옴~ 오키!!

pi@raspberrypi 이렇게 되어 있다면 성공!!

가장 먼저 해야할 것은 패스워드 변경!!!!
아무래도 ssh로 접속을 한 것이고~ 바꿔주는 것이 좋다

```
$passwd
```
현재 비번인 raspberry와 바꿀 비번을 차례로 입력해주면 된다



